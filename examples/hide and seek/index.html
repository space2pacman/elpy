<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elpy.js</title>
</head>
<body>
    <style>
        body {
            background: #778f91;
        }
        
        #field {
            margin: auto;
        }
    </style>
    <canvas id="field"></canvas>

    <script src="../../dist/elpy.min.js"></script>
    <script>
        const map = {
            barricades: [
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            ],
            land: [
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            ]
        };
        const options = {
            character: {
                image: 'images/tank_green.png',
                obstacles: true,
                custom: {
                    step: 1
                }
            },
            bot: {
                images: [
                    {
                        paths: ['images/tank_red.png'],
                        state: 'default'
                    },
                    {
                        paths: ['images/explosion1.png', 'images/explosion2.png', 'images/explosion3.png', 'images/explosion4.png', 'images/explosion5.png'],
                        state: 'explosion',
                        time: 100
                    }
                ],
                obstacles: true,
                custom: {
                    angle: 0,
                    step: 2
                }
            }
        }
        const indexes = {
            barricades: {
                '1': 'crateMetal',
                '2': 'barricadeMetal'
            },
            land: {
                '0': 'tileSand1'
            }
        }
        const elpy = new Elpy('#field', 784, 784);
        const obstacles = [];
        const BULLET_DISTANCE = 1000;
        const BULLET_SPEED = 10;
        const BULLET_STEP = 10;
        let buleltIndex = 0;
        let directons = ['h', 'v'];
        let direction = 'h';
        let lastTimeUpdate = Date.now();
        let interval = 1000;
        
        placeObjects('land', indexes.land, 64, 64);
        placeObjects('barricades', indexes.barricades, 28, 28, true);
        
        const character = elpy.create('character', 200, 300, 42, 46, options.character);
        //const bot = elpy.create('bot', 300, 300, 42, 46, options.bot);

        //

        character.on('move', () => {
            elpy._rays = [];
            elpy.rayCast(character.x, character.y);
        });
        
        //

        obstacles.push(character);
        //obstacles.push(bot);
        elpy.add(character);

        //elpy.add(bot);
        character.collision(obstacles);
        //bot.collision(obstacles);

        // bot.on('collision', (object, side) => {
        //     if (object.options.type === 'crateMetal') {
        //         if (side === 'top') {
        //             bot.options.custom.angle = 90;
        //             bot.rotate(bot.options.custom.angle);
        //         }

        //         if (side === 'right') {
        //             bot.options.custom.angle = 180;
        //             bot.rotate(bot.options.custom.angle);
        //         }

        //         if (side === 'bottom') {
        //             bot.options.custom.angle = 270;
        //             bot.rotate(bot.options.custom.angle);
        //         }

        //         if (side === 'left') {
        //             bot.options.custom.angle = 0;
        //             bot.rotate(bot.options.custom.angle);
        //         }
        //     }
        // });

        // setInterval(() => {
        //     const currentDate = Date.now();

        //     if (currentDate > lastTimeUpdate + interval) {
        //         lastTimeUpdate = currentDate;

        //         direction = directons[getRandomRange(0, directons.length)]
        //     }

        //     if (direction === 'h') {
        //         if (bot.x > character.x + character.width) {
        //             bot.options.custom.angle = 90;
        //         }

        //         if (bot.x + bot.width < character.x) {
        //             bot.options.custom.angle = 270;
        //         }
        //     }

        //     if (direction === 'v') {
        //         if (bot.y > character.y + character.height) {
        //             bot.options.custom.angle = 180;
        //         }

        //         if (bot.y + bot.height < character.y) {
        //             bot.options.custom.angle = 0;
        //         }
        //     }

        //     bot.rotate(bot.options.custom.angle);
        //     bot.run(1, bot.options.custom.step);
        // }, 30);

        elpy.key(key => {
            switch(key) {
                case 'ArrowUp':
                    character.run(1, character.options.custom.step)
                    //character.rotate(180);

                    break;
                case 'ArrowDown':
                    character.run(-1, character.options.custom.step)
                    //character.rotate(0);

                    break;
                case 'ArrowRight':
                    character.rotate(character.degrees + 3);

                    break;
                case 'ArrowLeft':
                    character.rotate(character.degrees - 3);

                    break;

            }
        });

        elpy.load();

        function placeObjects(type, indexes, width, height, isObstacles = false) {
            for(let i = 0; i < map[type].length; i++) {
                for(let j = 0; j < map[type][i].length; j++) {
                    const cell = map[type][i][j];
                    const keys = Object.keys(indexes);
                    const convertedKeys = keys.map(key => Number(key));

                    if (convertedKeys.includes(cell)) {
                        const name = indexes[cell];
                        const object = elpy.create(`${name}-${i}-${j}`, width * j, height * i , width, height, { image: `images/${name}.png`, type: name, obstacles: isObstacles });

                        elpy.add(object);
                        obstacles.push(object);
                    }
                }
            }
        }

        function getRandomRange(min, max) {
            return Math.floor(Math.random() * (max - min) + min);
        }
    </script>
</body>
</html>