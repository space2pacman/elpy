<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elpy.js</title>
</head>
<body>
    <style>
        #field {
            margin: auto;
            border: 1px solid #dcdcdc;
        }
    </style>
    <canvas id="field"></canvas>

    <script src="../../dist/elpy.min.js"></script>
    <script>
        const options = {
            character: {
                images: [
                    {
                        paths: ['images/characters/character_idle_0000.png'],
                        state: 'idle'
                    },
                    {
                        paths: ['images/characters/character_right_0000.png', 'images/characters/character_right_0001.png'],
                        state: 'move:right',
                        time: 100
                    },
                    {
                        paths: ['images/characters/character_left_0000.png', 'images/characters/character_left_0001.png'],
                        state: 'move:left',
                        time: 100
                    }
                ],
            },
            enemy: {
                images: [
                    {
                        paths: ['images/enemies/enemy_move_left_0.png'],
                        state: 'move:left'
                    },
                    {
                        paths: ['images/enemies/enemy_move_right_0.png'],
                        state: 'move:right'
                    }
                ],
                type: 'enemy',
                custom: {
                    delta: -1,
                    moving: false
                }
            },
            background: {
                image: {
                    src: 'images/background/background_0000.png',
                    repeat: true
                }
            },
            ground: {
                image: {
                    src: 'images/tiles/ground.png',
                    repeat: true
                },
                type: 'ground'
            },
            box: {
                image: 'images/tiles/box.png',
                type: 'box'
            },
            pipeHole: {
                image: 'images/tiles/pipeHole.png',
                type: 'pipe-hole'
            },
            pipe: {
                image: 'images/tiles/pipe.png'
            },
            treasure: {
                images: [
                    {
                        paths: ['images/tiles/treasure.png'],
                        state: 'full'
                    },
                    {
                        paths: ['images/tiles/treasure_empty.png'],
                        state: 'empty'
                    }
                ],
                type: 'treasure'
            },
            coin: {
                obstacle: false,
                images: [
                    {
                        paths: ['images/tiles/coin-0.png', 'images/tiles/coin-1.png'],
                        state: 'rotate',
                        time: 100
                    }
                ],
            }
        }

        const map = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 5, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 1, 5, 1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 5, 0, 0, 5, 0, 0, 5, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 4, 2, 0, 0, 0, 0, 0, 4, 0, 0, 0, 2, 0, 2, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 2, 0, 2, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 2, 0, 0, 0, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        ];

        const enums = {
            box: 1,
            enemy: 2,
            pipeHole: 3,
            pipe: 4,
            treasure: 5
        }

        const unit = 24;
        const step = 3;
        const grounds = [];
        const obstacles = [];
        const elpy = new Elpy('#field', 500, unit * 15);
        const background = elpy.create('background', -10000, -10000, 20000, 20000, options.background);

        //
        const flagpoleTip = elpy.create('flagpole-tip', (unit * 198) + 9, (unit * 3), 6, 4, {
            image: 'images/tiles/flagpoleTip.png'
        });

        const flagpole = elpy.create('flagpole', (unit * 198) + 9, (unit * 3) + 4, 6, (unit * 9) - 4, {
            obstacle: false,
            image: {
                src: 'images/tiles/flagpole.png',
                repeat: true
            }
        });

        const flag = elpy.create('flag', (unit * 198) + 9, (unit * 3) + 4, 18, 18, {
            images: [
                {
                    paths: ['images/tiles/flag_up.png', 'images/tiles/flag_down.png'],
                    state: 'flutters',
                    time: 100
                }
            ]
        });

        flag.animate = true;
        
        elpy.add(flagpoleTip);
        elpy.add(flagpole);
        elpy.add(flag);

        obstacles.push(flagpole);
        //

        const character = elpy.create('character', (Math.floor(elpy.width / unit) / 2) * unit, unit * 10, 20, unit, options.character);
        const CHARACTER_JUMP_HEIGHT = 100;
        const CHARACTER_JUMP_REBOUND = 10;
        const CHARACTER_JUMP_MULTIPLIER = 0.3;
        const FALL_MULTIPLIER = 0.3;
        const TREASURE_JUMP_HEIGHT = 10;
        const TREASURE_JUMP_MULTIPLIER = 1;
        const TREASURE_FALL_MULTIPLIER = 0.3;
        const ENEMY_JUMP_MULTIPLIER = 1;
        const ENEMY_JUMP_HEIGHT = 20;
        const ENEMY_ROTATE = 180;
        const DESTROY_TIME_DELAY = 500;
        const COIN_JUMP_HEIGHT = 30;
        const MAX_FLAG_LOWERING_HEIGHT = 270;
        const MAX_MAP_LENGTH = (map[0].length - 1) * unit;
        let isAnimate = false;
        let coinCounter = 0;
        
        elpy.add(background);
        elpy.add(character);
        character.move(4700, character.y);
        elpy.fixingCamera(character, {
            x: true
        });

        loadHiddenObjectTextures();

        const ground01 = elpy.create('ground01', 0, unit * 13, unit * 69, unit * 2, options.ground);
        const ground02 = elpy.create('ground02', unit * 71, unit * 13, unit * 15, unit * 2, options.ground);
        const ground03 = elpy.create('ground03', unit * 89, unit * 13, unit * 64, unit * 2, options.ground);
        const ground04 = elpy.create('ground04', unit * 155, unit * 13, unit * 69, unit * 2, options.ground);

        grounds.push(ground01);
        grounds.push(ground02);
        grounds.push(ground03);
        grounds.push(ground04);
        elpy.add(grounds);

        placeObjects();
        setObstaclesParams();

        character.collision(obstacles);
        character.collision(grounds);
        character.fall(FALL_MULTIPLIER);
        character.on('move', characterOnMove);
        character.on('collision', characterOnCollision);

        elpy.key(key => {
            switch(key) {
                case 'ArrowUp':
                    character.jump(CHARACTER_JUMP_HEIGHT, CHARACTER_JUMP_MULTIPLIER);
                    
                    break;
                case 'ArrowLeft':
                    character.move(character.x - step, character.y);

                    break;
                case 'ArrowRight':
                    character.move(character.x + step, character.y);

                    break;
            }
        });

        elpy.keyup(key => {
            switch(key) {
                case 'ArrowLeft':
                case 'ArrowRight':
                    character.state = 'idle';
                    character.animate = false;
                    
                    isAnimate = false;

                    break;
            }
        });        

        function placeObjects() {
            for(let i = 0; i < map.length; i++) {
                for(let j = 0; j < map[i].length; j++) {
                    if (map[i][j] === enums.box) {
                        placeBoxes(i, j);
                    }

                    if (map[i][j] === enums.enemy) {
                       placeEnemies(i, j);
                    }

                    if (map[i][j] === enums.pipeHole) {
                        placePipeHoles(i, j);
                    }

                    if (map[i][j] === enums.pipe) {
                        placePipe(i, j);
                    }

                    if (map[i][j] === enums.treasure) {
                        placeTreasures(i, j);
                    }
                }
            }
        }

        function placeBoxes(i, j) {
            const box = elpy.create(`box-${i}-${j}`, unit * j, unit * i, unit, unit, options.box);
                        
            elpy.add(box);
            obstacles.push(box);
        }

        function placeEnemies(i, j) {
            const enemy = elpy.create(`enemy-${i}-${j}`, unit * j, unit * i, 15, 13, JSON.parse(JSON.stringify(options.enemy)));

            enemy.animate = true;
            
            elpy.add(enemy);
            obstacles.push(enemy);
            enemy.on('fall', event => {
                enemyOnFall(enemy, event);
            });
        }

        function placePipeHoles(i, j) {
            const pipeHole = elpy.create(`pipe-hole-${i}-${j}`, unit * j, unit * i, unit, unit, options.pipeHole);
                        
            elpy.add(pipeHole);
            obstacles.push(pipeHole);
        }

        function placePipe(i, j) {
            const pipe = elpy.create(`pipe-${i}-${j}`, unit * j, unit * i, unit, unit, options.pipe);
                        
            elpy.add(pipe);
            obstacles.push(pipe);
        }

        function placeTreasures(i, j) {
            const treasure = elpy.create(`treasure-${i}-${j}`, unit * j, unit * i, unit, unit, options.treasure);
                        
            elpy.add(treasure);
            obstacles.push(treasure);
            treasure.collision(getObstaclesEnemies());
            treasure.on('collision', object => {
                treasureOnCollision(treasure, object);
            });

            rebound(treasure, TREASURE_FALL_MULTIPLIER);
        }

        function characterOnMove() {
            if (character.x > character.track.x) {
                if (!isAnimate) {
                    character.animate = true;
                    
                    isAnimate = true;
                }

                character.state = 'move:right';
            }

            if (character.x < character.track.x) {
                if (!isAnimate) {
                    character.animate = true;
                    
                    isAnimate = true;
                }

                character.state = 'move:left';
            }

            if (character.x <= 0) {
                character.move(character.x + 1, character.y);
                
                character.state = 'idle';
            }

            if (character.x >= MAX_MAP_LENGTH) {
                character.move(character.x - 1, character.y);
                
                character.state = 'idle';
            }

            checkObstaclesInViewport();
        }

        function characterOnCollision(object, side) {
            character.state = 'idle';

            if (object.options.type === 'enemy') {
                checkEnemyCollision(object, side);
            }

            if (object.options.type === 'treasure' && side === 'bottom' && object.state === 'full') {
                checkTreasureCollision(object);
            }

            if (object.name === 'flagpole') {
                lowerFlag();
            }
        }

        function enemyOnFall(enemy, event) {
            if (elpy.checkObjectInViewport(enemy)) {
                event.resume();
            } else {
                event.pause();
            }
            
            if (enemy.ghost) {
                event.stop();
            }
        }

        function treasureOnCollision(treasure, object) {
            object.ghost = true;
            
            object.jump(ENEMY_JUMP_HEIGHT, ENEMY_JUMP_MULTIPLIER);
            object.rotate(ENEMY_ROTATE);
            treasure.jump(TREASURE_JUMP_HEIGHT, TREASURE_JUMP_MULTIPLIER, true);
            
            delayedDestroy(object, DESTROY_TIME_DELAY);
        }

        function getObstaclesEnemies() {
            return obstacles.filter(obstacle => obstacle.options.type === 'enemy');
        }

        function setObstaclesParams() {
            obstacles.forEach(obstacle => {
                if (obstacle.options.type === 'enemy') {
                    obstacle.on('collision', (object, side) => {
                        if (side === 'left') {
                            obstacle.options.custom.delta = -1;
                            obstacle.state = 'move:left';
                        }

                        if (side === 'right' || obstacle.x >= MAX_MAP_LENGTH) {
                            obstacle.options.custom.delta = 1;
                            obstacle.state = 'move:right';
                        }
                    });

                    obstacle.on('move', () => {
                        if (obstacle.y >= elpy.height) {
                            obstacle.destroy();
                        }
                    });

                    obstacle.collision(obstacles);
                    obstacle.collision(character);
                    obstacle.collision(grounds);
                    obstacle.fall(FALL_MULTIPLIER);
                }
            });
        }

        function moveObstacle(obstacle) {
            if (!obstacle.options.custom.moving) {
                obstacle.options.custom.moving = true;

                elpy.tick(() => {
                    if (!elpy.checkObjectInViewport(obstacle) || obstacle.ghost) {
                        obstacle.options.custom.moving = false;

                        return false;
                    }

                    obstacle.move(obstacle.x + obstacle.options.custom.delta, obstacle.y);
                });
            }
        }

        function checkObstaclesInViewport() {
            obstacles.forEach(obstacle => {
                if (obstacle.options.type === 'enemy') {
                    if (elpy.checkObjectInViewport(obstacle)) {
                        moveObstacle(obstacle);
                    } else {
                        obstacle.options.custom.moving = false;
                    }
                }
            });
        }

        function checkEnemyCollision(object, side) {
            if (side === 'top') {
                elpy.nextTick(() => {
                    character.jump(CHARACTER_JUMP_REBOUND, CHARACTER_JUMP_MULTIPLIER);
                });

                const height = object.height / 2;

                object.height = height;
                object.y = object.y + height;
                object.ghost = true;

                delayedDestroy(object, DESTROY_TIME_DELAY);
            }
        }

        function checkTreasureCollision(object) {
            object.jump(TREASURE_JUMP_HEIGHT, TREASURE_JUMP_MULTIPLIER);

            object.state = 'empty';
                
            dropCoin(object);
        }

        function rebound(object, fallMultiplier = 0.1) {
            const y = object.y;

            object.on('fall', event => {
                if (object.y >= y) {
                    object.move(object.x, y);
                    event.stop();
                }
            });

            object.on('jump', event => {
                if (object.y === object.track.y) {
                    event.stop();
                    object.fall(fallMultiplier)
                }
            });
        }

        function dropCoin(object) {
            const coin = elpy.create('coin' + coinCounter, object.x + 3, object.y - object.height, 18, 18, options.coin);

            coinCounter++;

            coin.on('jump', event => {
                if (coin.y === coin.track.y) {
                    event.stop();

                    delayedDestroy(coin, DESTROY_TIME_DELAY);
                }
            });

            coin.animate = true;

            elpy.add(coin);
            coin.jump(COIN_JUMP_HEIGHT);
        }

        function delayedDestroy(object, time) {
            setTimeout(() => {
                object.destroy();
            }, time);
        }

        function loadHiddenObjectTextures() {
            const coin = elpy.create('coin', 0, 0, 0, 0, options.coin);

            elpy.add(coin);
            elpy.on('load', () => {
                coin.destroy();
            });
        }

        function lowerFlag() {
            if (flag.y >= MAX_FLAG_LOWERING_HEIGHT) {
                return;
            }
            
            let y = flag.y;

            elpy.tick(() => {
                if (y >= MAX_FLAG_LOWERING_HEIGHT) {
                    return false;
                }

                flag.move(flag.x, y);

                y += 2;
            })
        }
    </script>
</body>
</html>